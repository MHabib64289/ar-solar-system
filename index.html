<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR Solar System - Fixed</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }
    
    .ui-overlay {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 999;
      color: white;
      background: rgba(0,0,0,0.85);
      padding: 15px;
      border-radius: 12px;
      font-size: 13px;
      backdrop-filter: blur(10px);
      pointer-events: none;
    }
    
    .ui-overlay strong {
      display: block;
      font-size: 18px;
      margin-bottom: 8px;
      color: #4fc3f7;
    }
    
    .marker-type {
      display: inline-block;
      background: rgba(76, 175, 80, 0.3);
      color: #81c784;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin: 5px 5px 5px 0;
    }
    
    .status {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.2);
      font-size: 12px;
    }

    .controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      width: calc(100% - 40px);
      max-width: 400px;
    }
    
    button {
      background: linear-gradient(135deg, #4fc3f7, #29b6f6);
      border: 2px solid rgba(255,255,255,0.3);
      padding: 16px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 13px;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(79, 195, 247, 0.4);
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      touch-action: manipulation;
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    button .icon {
      font-size: 24px;
    }

    .marker-help {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 998;
      text-align: center;
      pointer-events: none;
      max-width: 90%;
    }
    
    .marker-frame {
      width: min(60vw, 250px);
      height: min(60vw, 250px);
      border: 3px dashed #4fc3f7;
      border-radius: 20px;
      margin: 0 auto 20px;
      animation: pulse 2s infinite;
      background: rgba(79, 195, 247, 0.1);
    }
    
    @keyframes pulse {
      0%, 100% { 
        opacity: 0.6;
        transform: scale(1);
      }
      50% { 
        opacity: 1;
        transform: scale(1.05);
      }
    }
    
    .marker-text {
      color: white;
      background: rgba(0,0,0,0.9);
      padding: 15px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      line-height: 1.6;
    }
    
    .marker-download {
      margin-top: 15px;
      padding: 12px 20px;
      background: rgba(76, 175, 80, 0.9);
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .hidden {
      display: none !important;
    }
    
    .loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(79, 195, 247, 0.3);
      border-top: 4px solid #4fc3f7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .troubleshooting {
      position: fixed;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 998;
      background: rgba(255, 152, 0, 0.95);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 12px;
      max-width: 90%;
      text-align: center;
      font-weight: 600;
      line-height: 1.5;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translate(-50%, 20px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div>Memuat AR Camera...</div>
  </div>

  <div class="ui-overlay">
    <strong>üåç AR Solar System</strong>
    <div>
      <span class="marker-type">HIRO Marker</span>
      <span class="marker-type">Kairos Marker</span>
    </div>
    <div class="status" id="status">Menginisialisasi...</div>
  </div>

  <div class="marker-help" id="markerHelp">
    <div class="marker-frame"></div>
    <div class="marker-text">
      Arahkan kamera ke marker:<br>
      <strong>HIRO atau KAIROS</strong><br>
      <small style="opacity: 0.8;">Pastikan pencahayaan cukup & marker terlihat jelas</small>
    </div>
    <div class="marker-download">
      üí° Download marker HIRO:<br>
      <strong>https://jeromeetienne.github.io/AR.js/data/images/hiro.png</strong>
    </div>
  </div>

  <div class="troubleshooting hidden" id="troubleshoot">
    <strong>‚ö†Ô∏è Tips Jika Tidak Terdeteksi:</strong><br>
    ‚Ä¢ Pastikan izin kamera diaktifkan<br>
    ‚Ä¢ Gunakan pencahayaan yang baik<br>
    ‚Ä¢ Cetak marker atau tampilkan di layar lain<br>
    ‚Ä¢ Jaga jarak 20-40cm dari kamera
  </div>

  <div class="controls">
    <button onclick="toggleEclipse()">
      <span class="icon" id="eclipseIcon">üåë</span>
      <span id="eclipseText">Gerhana</span>
    </button>
    <button onclick="toggleSpeed()">
      <span class="icon">‚ö°</span>
      <span id="speedText">1x</span>
    </button>
    <button onclick="toggleRotate()">
      <span class="icon" id="rotateIcon">üîÑ</span>
      <span id="rotateText">Putar</span>
    </button>
    <button onclick="resetView()">
      <span class="icon">üì∑</span>
      <span>Reset</span>
    </button>
  </div>

  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; precision: medium; antialias: true;"
    id="arScene">
    
    <a-assets timeout="30000">
      <img id="earthTex" src="https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/earth_atmos_2048.jpg" crossorigin="anonymous">
      <img id="moonTex" src="https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/moon_1024.jpg" crossorigin="anonymous">
      <img id="sunTex" src="https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/sun.jpg" crossorigin="anonymous">
    </a-assets>

    <a-camera look-controls="enabled: false"></a-camera>

    <!-- HIRO Marker -->
    <a-marker preset="hiro" id="hiroMarker" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      <a-entity id="solarSystem1" position="0 0 0" scale="0.7 0.7 0.7">
        <!-- Sun -->
        <a-entity id="sun1" position="-3 0.5 0">
          <a-sphere radius="0.7" src="#sunTex" material="emissive: #ff6600; emissiveIntensity: 0.8" animation="property: rotation; to: 0 360 0; dur: 20000; loop: true; easing: linear"></a-sphere>
          <a-sphere radius="0.8" color="#ffcc44" material="transparent: true; opacity: 0.3; side: double" animation="property: scale; to: 1.15 1.15 1.15; dir: alternate; dur: 2000; loop: true"></a-sphere>
          <a-sphere id="corona1a" radius="1.0" color="#ffffdd" material="transparent: true; opacity: 0; side: back" visible="false"></a-sphere>
        </a-entity>

        <!-- Earth System -->
        <a-entity id="earthSystem1" rotation="0 0 -23.4">
          <a-sphere id="earth1" radius="0.6" src="#earthTex" material="metalness: 0.1; roughness: 0.7" animation="property: rotation; to: 0 360 0; dur: 12000; loop: true; easing: linear">
            <a-sphere radius="0.61" color="#ffffff" material="transparent: true; opacity: 0.4" animation="property: rotation; to: 0 370 0; dur: 14000; loop: true"></a-sphere>
          </a-sphere>

          <!-- Moon Orbit -->
          <a-entity id="moonOrbit1" animation="property: rotation; to: 0 360 0; dur: 18000; loop: true; easing: linear; pauseEvents: pause1; resumeEvents: resume1">
            <a-sphere id="moon1" position="1.8 0.2 0" radius="0.16" src="#moonTex" material="roughness: 0.95" animation="property: rotation; to: 0 360 0; dur: 27000; loop: true"></a-sphere>
            <a-ring radius-inner="1.75" radius-outer="1.78" color="#99aacc" segments-theta="64" material="transparent: true; opacity: 0.25; side: double" rotation="-90 0 0"></a-ring>
          </a-entity>
        </a-entity>

        <!-- Lighting -->
        <a-light type="ambient" color="#404050" intensity="0.6"></a-light>
        <a-light type="directional" color="#ffffee" intensity="1.5" position="-3 1 2" id="sunLight1"></a-light>
      </a-entity>
    </a-marker>

    <!-- KAIROS Marker (alternative) -->
    <a-marker preset="kairos" id="kairosMarker" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      <a-entity id="solarSystem2" position="0 0 0" scale="0.7 0.7 0.7">
        <!-- Sun -->
        <a-entity id="sun2" position="-3 0.5 0">
          <a-sphere radius="0.7" src="#sunTex" material="emissive: #ff6600; emissiveIntensity: 0.8" animation="property: rotation; to: 0 360 0; dur: 20000; loop: true; easing: linear"></a-sphere>
          <a-sphere radius="0.8" color="#ffcc44" material="transparent: true; opacity: 0.3; side: double" animation="property: scale; to: 1.15 1.15 1.15; dir: alternate; dur: 2000; loop: true"></a-sphere>
          <a-sphere id="corona1b" radius="1.0" color="#ffffdd" material="transparent: true; opacity: 0; side: back" visible="false"></a-sphere>
        </a-entity>

        <!-- Earth System -->
        <a-entity id="earthSystem2" rotation="0 0 -23.4">
          <a-sphere id="earth2" radius="0.6" src="#earthTex" material="metalness: 0.1; roughness: 0.7" animation="property: rotation; to: 0 360 0; dur: 12000; loop: true; easing: linear">
            <a-sphere radius="0.61" color="#ffffff" material="transparent: true; opacity: 0.4" animation="property: rotation; to: 0 370 0; dur: 14000; loop: true"></a-sphere>
          </a-sphere>

          <!-- Moon Orbit -->
          <a-entity id="moonOrbit2" animation="property: rotation; to: 0 360 0; dur: 18000; loop: true; easing: linear; pauseEvents: pause2; resumeEvents: resume2">
            <a-sphere id="moon2" position="1.8 0.2 0" radius="0.16" src="#moonTex" material="roughness: 0.95" animation="property: rotation; to: 0 360 0; dur: 27000; loop: true"></a-sphere>
            <a-ring radius-inner="1.75" radius-outer="1.78" color="#99aacc" segments-theta="64" material="transparent: true; opacity: 0.25; side: double" rotation="-90 0 0"></a-ring>
          </a-entity>
        </a-entity>

        <!-- Lighting -->
        <a-light type="ambient" color="#404050" intensity="0.6"></a-light>
        <a-light type="directional" color="#ffffee" intensity="1.5" position="-3 1 2" id="sunLight2"></a-light>
      </a-entity>
    </a-marker>
  </a-scene>

  <script>
    let eclipseMode = false;
    let speedMultiplier = 1;
    let rotationPaused = false;
    let markerDetected = false;
    let activeMarker = null;
    let noDetectionTimer = null;

    function updateStatus(msg) {
      const el = document.getElementById('status');
      if (el) el.textContent = msg;
    }

    function showTroubleshooting() {
      const el = document.getElementById('troubleshoot');
      if (el) el.classList.remove('hidden');
    }

    function hideTroubleshooting() {
      const el = document.getElementById('troubleshoot');
      if (el) el.classList.add('hidden');
    }

    // Check if no marker detected for 10 seconds
    function startNoDetectionTimer() {
      noDetectionTimer = setTimeout(() => {
        if (!markerDetected) {
          showTroubleshooting();
        }
      }, 10000);
    }

    window.addEventListener('load', () => {
      setTimeout(() => {
        const loading = document.getElementById('loading');
        if (loading) {
          loading.style.opacity = '0';
          loading.style.transition = 'opacity 0.5s';
          setTimeout(() => loading.remove(), 500);
        }
        updateStatus('üìπ Kamera siap! Arahkan ke marker');
        startNoDetectionTimer();
      }, 2000);
    });

    // HIRO Marker Events
    const hiroMarker = document.querySelector('#hiroMarker');
    if (hiroMarker) {
      hiroMarker.addEventListener('markerFound', () => {
        markerDetected = true;
        activeMarker = 'hiro';
        document.getElementById('markerHelp').classList.add('hidden');
        hideTroubleshooting();
        updateStatus('‚úÖ HIRO Marker terdeteksi!');
        if (navigator.vibrate) navigator.vibrate(50);
      });

      hiroMarker.addEventListener('markerLost', () => {
        markerDetected = false;
        activeMarker = null;
        document.getElementById('markerHelp').classList.remove('hidden');
        updateStatus('‚ùå Marker hilang - cari marker');
      });
    }

    // KAIROS Marker Events
    const kairosMarker = document.querySelector('#kairosMarker');
    if (kairosMarker) {
      kairosMarker.addEventListener('markerFound', () => {
        markerDetected = true;
        activeMarker = 'kairos';
        document.getElementById('markerHelp').classList.add('hidden');
        hideTroubleshooting();
        updateStatus('‚úÖ KAIROS Marker terdeteksi!');
        if (navigator.vibrate) navigator.vibrate(50);
      });

      kairosMarker.addEventListener('markerLost', () => {
        markerDetected = false;
        activeMarker = null;
        document.getElementById('markerHelp').classList.remove('hidden');
        updateStatus('‚ùå Marker hilang - cari marker');
      });
    }

    function toggleEclipse() {
      eclipseMode = !eclipseMode;
      const icon = document.getElementById('eclipseIcon');
      const text = document.getElementById('eclipseText');
      
      ['corona1a', 'corona1b'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.setAttribute('visible', eclipseMode);
          if (eclipseMode) {
            el.setAttribute('material', 'opacity', '0.5');
            el.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 8000; loop: true');
          }
        }
      });

      ['sunLight1', 'sunLight2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.setAttribute('intensity', eclipseMode ? '0.3' : '1.5');
      });

      icon.textContent = eclipseMode ? '‚òÄÔ∏è' : 'üåë';
      text.textContent = eclipseMode ? 'Normal' : 'Gerhana';
      updateStatus(eclipseMode ? 'üåë Mode Gerhana' : '‚òÄÔ∏è Mode Normal');
      if (navigator.vibrate) navigator.vibrate(30);
    }

    function toggleSpeed() {
      const speeds = [1, 2, 0.5, 4];
      const idx = speeds.indexOf(speedMultiplier);
      speedMultiplier = speeds[(idx + 1) % speeds.length];
      document.getElementById('speedText').textContent = `${speedMultiplier}x`;

      ['earth1', 'earth2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.setAttribute('animation', `property: rotation; to: 0 360 0; dur: ${12000 / speedMultiplier}; loop: true; easing: linear`);
      });

      ['moonOrbit1', 'moonOrbit2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.setAttribute('animation', `property: rotation; to: 0 360 0; dur: ${18000 / speedMultiplier}; loop: true; easing: linear`);
      });

      updateStatus(`‚ö° Kecepatan: ${speedMultiplier}x`);
      if (navigator.vibrate) navigator.vibrate(30);
    }

    function toggleRotate() {
      rotationPaused = !rotationPaused;
      const icon = document.getElementById('rotateIcon');
      const text = document.getElementById('rotateText');

      ['moonOrbit1', 'moonOrbit2'].forEach((id, idx) => {
        const el = document.getElementById(id);
        if (el) el.emit(rotationPaused ? `pause${idx + 1}` : `resume${idx + 1}`);
      });

      icon.textContent = rotationPaused ? '‚ñ∂Ô∏è' : 'üîÑ';
      text.textContent = rotationPaused ? 'Lanjut' : 'Putar';
      updateStatus(rotationPaused ? '‚è∏Ô∏è Rotasi Pause' : '‚ñ∂Ô∏è Rotasi Play');
      if (navigator.vibrate) navigator.vibrate(30);
    }

    function resetView() {
      ['solarSystem1', 'solarSystem2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.setAttribute('scale', '0.7 0.7 0.7');
          el.setAttribute('position', '0 0 0');
        }
      });
      updateStatus('üì∑ View direset');
      if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
    }

    const scene = document.querySelector('#arScene');
    if (scene) {
      scene.addEventListener('arjs-video-loaded', () => {
        updateStatus('üìπ Kamera aktif! Scan marker');
      });
    }
  </script>
</body>
</html>
